<app-barra-titulo
  [titulo]="'INFRAESTRUCTURA'"
  (clickAyuda)="abrirModalAyuda()">
</app-barra-titulo>

<app-modal-ayuda
  [visible]="modalAbierto"
  [titulo]="'¬øQu√© muestra este apartado?'"
  [mensaje]="'Este panel muestra el estado de servidores, uso de recursos (CPU, RAM, disco), servicios, equipos sin m√©tricas y latencias de red por zona.'"
  (cerrar)="cerrarModalAyuda()">
</app-modal-ayuda>

<div class="dashboard-doble-columna">
  <!-- TULTITL√ÅN -->
  <div class="zona-column">
    <div class="alerta-kpi" 
    [ngClass]="getClaseContadorCritico(infraTultitlan)" 
    (click)="abrirModalCriticos('TULTITLAN')">
    üî¥ Alertas Cr√≠ticas: {{ contarCriticas(infraTultitlan) }}
  </div>
  
    <div class="zona-titulo">TULTITL√ÅN</div>
    <table class="tabla-ip">
      <thead>
        <tr>
          <th>Servidor</th>
          <th><lucide-icon name="Cpu" class="icono-header" /> CPU</th>
          <th><lucide-icon name="MemoryStick" class="icono-header" /> RAM</th>
          <th><lucide-icon name="HardDrive" class="icono-header" /> FS</th>
          <th><lucide-icon name="ServerCog" class="icono-header" /> Servicios</th>
          <th><lucide-icon name="Ban" class="icono-header" /> Sin M√©tricas</th>
          <th><lucide-icon name="Globe" class="icono-header" /> Latencia</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of infraTultitlan">
          <td>{{ s.servidor }}</td>
          <td [ngClass]="getClaseAlarma(s.cpu)">
            {{ s.cpu }}%
            <span *ngIf="s.cpu >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'CPU cr√≠tica: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.cpu >= 71 && s.cpu < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'CPU alta: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseAlarma(s.ram)">
            {{ s.ram }}%
            <span *ngIf="s.ram >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'RAM cr√≠tica: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.ram >= 71 && s.ram < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'RAM alta: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseAlarma(s.fs)">
            {{ s.fs }}%
            <span *ngIf="s.fs >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'File System cr√≠tico: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.fs >= 71 && s.fs < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'File System alto: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseServicios(s.estadoServicios)">
            {{ s.estadoServicios }}
            <span *ngIf="s.estadoServicios === 'Ca√≠do'" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Servicio ca√≠do')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.estadoServicios === 'Degradado'" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'Servicio degradado')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseMetricas(s.tieneMetricas)">
            {{ s.tieneMetricas ? 'No' : 'S√≠' }}
            <span *ngIf="!s.tieneMetricas" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Sin m√©tricas disponibles')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
          </td>
          <td [ngClass]="getClaseLatencia(s.latenciaRed)">
            {{ s.latenciaRed }} ms
            <span *ngIf="s.latenciaRed > 60" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Latencia cr√≠tica: mayor a 60ms')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.latenciaRed > 30 && s.latenciaRed <= 60" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'Latencia alta: entre 30ms y 60ms')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- QUER√âTARO -->
  <div class="zona-column">
    <div class="alerta-kpi" 
    [ngClass]="getClaseContadorCritico(infraQueretaro)" 
    (click)="abrirModalCriticos('QUERETARO')">
    üî¥ Alertas Cr√≠ticas: {{ contarCriticas(infraQueretaro) }}
   </div>
    <div class="zona-titulo">QUER√âTARO</div>
    <table class="tabla-ip">
      <thead>
        <tr>
          <th>Servidor</th>
          <th><lucide-icon name="Cpu" class="icono-header" /> CPU</th>
          <th><lucide-icon name="MemoryStick" class="icono-header" /> RAM</th>
          <th><lucide-icon name="HardDrive" class="icono-header" /> FS</th>
          <th><lucide-icon name="ServerCog" class="icono-header" /> Servicios</th>
          <th><lucide-icon name="Ban" class="icono-header" /> Sin M√©tricas</th>
          <th><lucide-icon name="Globe" class="icono-header" /> Latencia</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let s of infraQueretaro">
          <td>{{ s.servidor }}</td>
          <td [ngClass]="getClaseAlarma(s.cpu)">
            {{ s.cpu }}%
            <span *ngIf="s.cpu >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'CPU cr√≠tica: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.cpu >= 71 && s.cpu < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'CPU alta: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseAlarma(s.ram)">
            {{ s.ram }}%
            <span *ngIf="s.ram >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'RAM cr√≠tica: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.ram >= 71 && s.ram < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'RAM alta: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseAlarma(s.fs)">
            {{ s.fs }}%
            <span *ngIf="s.fs >= 90" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'File System cr√≠tico: uso mayor al 90%')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.fs >= 71 && s.fs < 90" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'File System alto: uso entre 71% y 89%')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseServicios(s.estadoServicios)">
            {{ s.estadoServicios }}
            <span *ngIf="s.estadoServicios === 'Ca√≠do'" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Servicio ca√≠do')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.estadoServicios === 'Degradado'" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'Servicio degradado')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
          <td [ngClass]="getClaseMetricas(s.tieneMetricas)">
            {{ s.tieneMetricas ? 'No' : 'S√≠' }}
            <span *ngIf="!s.tieneMetricas" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Sin m√©tricas disponibles')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
          </td>
          <td [ngClass]="getClaseLatencia(s.latenciaRed)">
            {{ s.latenciaRed }} ms
            <span *ngIf="s.latenciaRed > 60" class="icono-alerta critico"
              (mouseenter)="mostrarTooltip($event, 'Latencia cr√≠tica: mayor a 60ms')"
              (mouseleave)="ocultarTooltip()">‚õîÔ∏è</span>
            <span *ngIf="s.latenciaRed > 30 && s.latenciaRed <= 60" class="icono-alerta advertencia"
              (mouseenter)="mostrarTooltip($event, 'Latencia alta: entre 30ms y 60ms')"
              (mouseleave)="ocultarTooltip()">‚ö†Ô∏è</span>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Tooltip flotante -->
<app-tooltip-flotante 
  [visible]="tooltipVisible" 
  [mensaje]="tooltipMensaje" 
  [x]="tooltipX" 
  [y]="tooltipY">
</app-tooltip-flotante>

<app-modal-ayuda
  [visible]="modalCriticosAbierto"
  [titulo]="'Alertas Cr√≠ticas - ' + zonaCriticaSeleccionada"
  [mensaje]="''"
  (cerrar)="cerrarModalCriticos()">
  
  <div class="lista-criticos">
    <div *ngIf="alertasCriticas.length > 0; else sinAlertas">
      <ul>
        <li *ngFor="let alerta of alertasCriticas">
          <strong>{{ alerta.servidor }}</strong> - {{ alerta.descripcion }}
        </li>
      </ul>
    </div>
    <ng-template #sinAlertas>
      <p>No hay alertas cr√≠ticas en esta zona üéâ</p>
    </ng-template>
  </div>
  
</app-modal-ayuda>
